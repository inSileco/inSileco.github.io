---
title: R in Space - Import spatial objects
author: [david, elliot, kevin, nicolas, marieh, remi, steve]
reviewer: []
date: 2018-04-02
tags: [R, Viz, Spatial, R in Space]
rpkgs: [sf, raster]
draft: true
estime: 16
---



<div id="reading-and-writing-spatial-objects-with-sf-and-raster" class="section level2">
<h2>Reading and writing spatial objects with sf and raster</h2>
<p>The <code>st_read</code> function can be used to read a wide range of vector formats, such as Shapefiles (.shp), Geodatabase (.gdb), GeoPackage (.gpkg), GeoJSON (.geojson). For the illustration of vector concepts, we will use different datasets available from the <a href="http://donnees.ville.montreal.qc.ca/dataset">Portail de données ouvertes of Montreal</a>; csv for points, shp for polgyons and geojson for lines .</p>
<p>The raster package supports raster objects in R. It provides an extensive set of functions to create, read, export, manipulate and process raster datasets. Rasters can be read with <code>raster</code>.</p>
</div>
<div id="packages-required" class="section level2">
<h2>Packages required</h2>
<p>We will use the <code>sf</code> and <code>raster</code> libraries in this tutorial.</p>
<pre class="r"><code>library(sf)</code></pre>
<pre><code>## Linking to GEOS 3.6.2, GDAL 2.2.4, proj.4 5.0.0</code></pre>
<pre class="r"><code>library(raster)</code></pre>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## 
## Attaching package: &#39;sp&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:graphicsutils&#39;:
## 
##     compassRose</code></pre>
<pre><code>## 
## Attaching package: &#39;raster&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:magrittr&#39;:
## 
##     extract</code></pre>
</div>
<div id="import-point-data-from-csv-file" class="section level2">
<h2>Import point data from csv file</h2>
<p>Spatial point data are sometimes stored in a text file format (.txt or .csv). If the text file has an associated x and y location column, then we can convert it into an sf spatial object. The sf object allows us to store both the x,y values that represent the coordinate location of each point and the associated attribute data - or columns describing each feature in the spatial object.</p>
<p>The point dataset represents sampling points of a monitoring program of water quality in Montreal (available <a href="http://donnees.ville.montreal.qc.ca/dataset/rsma-points-d-echantillonnage-ruisso/resource/adad6c48-fb48-40fc-a031-1ac870d978b4">here</a>).</p>
<pre class="r"><code># Create a new directory to download data
dir.create(&quot;data&quot;)

# Download csv file from web page in your working directory
download.file(&quot;http://donnees.ville.montreal.qc.ca/dataset/86843d31-4251-4002-b10d-620aaa751092/resource/adad6c48-fb48-40fc-a031-1ac870d978b4/download/scri03.-infor03.02-informatique03.02.07-donneesouvertesrsmaruissostationsstations_ruisso.csv&quot;, destfile = &quot;data/ruisso.csv&quot;)

# Read csv file in R
pts &lt;- read.csv(&quot;data/ruisso.csv&quot;, header = T, dec = &quot;,&quot;)

head(pts)</code></pre>
<pre><code>##         Plan.d.eau Point.d.échantillonnage
## 1 Rivière à l&#39;Orme                 AAO-0.0
## 2 Rivière à l&#39;Orme               AAO-1.5P1
## 3 Rivière à l&#39;Orme               AAO-2.0P4
## 4 Rivière à l&#39;Orme               AAO-3.3P6
## 5 Rivière à l&#39;Orme                 AAO-3.5
## 6 Rivière à l&#39;Orme                 AAO-3.6
##                                                                                                           Localisation
## 1            Pierrefonds, boul. Gouin O, 40m au nord de la rue de l&#39;Anse à l&#39;Orme, exutoire au lac des Deux Montagnes.
## 2                             Pierrefonds, N ponceau boul.Gouin, 1500m en amont exutoire,  branche provenant de l&#39;est.
## 3                            Ste-A.-de-Bellevue, branche drainant secteur ouest, 140m à l&#39;est de la rue Leslie Dowker.
## 4 Kirkland, 60m au sud de l&#39;intersection des rues de l&#39;Anse à l&#39;Orme et de Timberley trail, derrière le dépôt à neige.
## 5                          Sainte-Anne-de-Bellevue, 10m au nord du ch. Ste-Marie, 200m à l&#39;ouest du ch. Anse à l&#39;Orme.
## 6                       Beaconsfield, 250m à l&#39;est de la rue Lee et 25m au sud de l&#39;autoroute 40, en amont du pluvial.
##            Administration LATITUDE LONGITUDE Activité
## 1     Pierrefonds-Roxboro 45.45022 -73.93704    Actif
## 2     Pierrefonds-Roxboro 45.44744 -73.91931  Inactif
## 3 Sainte-Anne-de-Bellevue 45.44288 -73.91535  Inactif
## 4                Kirkland 45.43689 -73.90147    Actif
## 5 Sainte-Anne-de-Bellevue 45.43566 -73.90144    Actif
## 6             Baie d&#39;Urfé 45.43462 -73.90120    Actif</code></pre>
<pre class="r"><code>dim(pts)</code></pre>
<pre><code>## [1] 66  7</code></pre>
<pre class="r"><code># The pts data frame has 66 locations and 7 attributes</code></pre>
<div id="convert-data-frame-to-simple-features" class="section level3">
<h3>Convert data frame to simple features</h3>
<p>The data frame containing sampling points can be converted into simple feature objects using <code>st_as_sf</code>. We need to specify the columns containing the coordinate values (here <code>LATITUDE</code> and <code>LONGITUDE</code>) and the coordinate reference system, CRS, of these coordinates (here we know that the datum is WGS84 and the EPSG is 4326 from the <a href="http://donnees.ville.montreal.qc.ca/dataset/rsma-points-d-echantillonnage-ruisso/resource/adad6c48-fb48-40fc-a031-1ac870d978b4">metadata</a>). It is important to know the CRS of your point data, or any other spatial data, prior to converting to a spatial object in order to place correctly your coordinates on the Earth’s surface. In sf, the reference system can be define using the <code>proj4</code> format or directly with the EPSG code.</p>
<pre class="r"><code>pts_sf &lt;- st_as_sf(x = pts,
  coords = c(&quot;LONGITUDE&quot;, &quot;LATITUDE&quot;),
  crs = 4326)
head(pts_sf)</code></pre>
<pre><code>## Simple feature collection with 6 features and 5 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -73.93704 ymin: 45.43462 xmax: -73.9012 ymax: 45.45022
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
##         Plan.d.eau Point.d.échantillonnage
## 1 Rivière à l&#39;Orme                 AAO-0.0
## 2 Rivière à l&#39;Orme               AAO-1.5P1
## 3 Rivière à l&#39;Orme               AAO-2.0P4
## 4 Rivière à l&#39;Orme               AAO-3.3P6
## 5 Rivière à l&#39;Orme                 AAO-3.5
## 6 Rivière à l&#39;Orme                 AAO-3.6
##                                                                                                           Localisation
## 1            Pierrefonds, boul. Gouin O, 40m au nord de la rue de l&#39;Anse à l&#39;Orme, exutoire au lac des Deux Montagnes.
## 2                             Pierrefonds, N ponceau boul.Gouin, 1500m en amont exutoire,  branche provenant de l&#39;est.
## 3                            Ste-A.-de-Bellevue, branche drainant secteur ouest, 140m à l&#39;est de la rue Leslie Dowker.
## 4 Kirkland, 60m au sud de l&#39;intersection des rues de l&#39;Anse à l&#39;Orme et de Timberley trail, derrière le dépôt à neige.
## 5                          Sainte-Anne-de-Bellevue, 10m au nord du ch. Ste-Marie, 200m à l&#39;ouest du ch. Anse à l&#39;Orme.
## 6                       Beaconsfield, 250m à l&#39;est de la rue Lee et 25m au sud de l&#39;autoroute 40, en amont du pluvial.
##            Administration Activité                   geometry
## 1     Pierrefonds-Roxboro    Actif POINT (-73.93704 45.45022)
## 2     Pierrefonds-Roxboro  Inactif POINT (-73.91931 45.44744)
## 3 Sainte-Anne-de-Bellevue  Inactif POINT (-73.91535 45.44288)
## 4                Kirkland    Actif POINT (-73.90147 45.43689)
## 5 Sainte-Anne-de-Bellevue    Actif POINT (-73.90144 45.43566)
## 6             Baie d&#39;Urfé    Actif  POINT (-73.9012 45.43462)</code></pre>
<p>As you can see, we now have a <code>MULTIPOINT</code> geometry, and the spatial information is now stored in a simple feature list-column (<code>sfc</code>). The other columns contain all the attributes related to the sample points.</p>
<p>The default plot of a simple features object is a multi-facet of all attributes.</p>
<pre class="r"><code>plot(pts_sf)  </code></pre>
<p><img src="/rmarkdown-libs/figure-html4/plot_pts-1.png" width="672" /></p>
<p>As you can see, instead of creating a single map, as with sp object, the default plot of sf object creates multiple maps, one for each attribute, which can sometime be useful for exploring the spatial distribution of different variables.</p>
</div>
<div id="export-your-points-in-a-shapefile" class="section level3">
<h3>Export your points in a Shapefile</h3>
<p>We can write a simple features object to a file (e.g. a shapefile) using the <code>st_write</code> function in <code>sf</code>, which needs at least two arguments, the object and a filename:</p>
<pre class="r"><code>st_write(pts_sf, &quot;data/pts_sf.shp&quot;, delete_dsn = T)</code></pre>
<pre><code>## Warning in abbreviate(fld_names, minlength = 7): abbreviate used with non-
## ASCII chars</code></pre>
<pre><code>## Warning in abbreviate_shapefile_names(obj): Field names abbreviated for
## ESRI Shapefile driver</code></pre>
<pre><code>## Warning in CPL_write_ogr(obj, dsn, layer, driver,
## as.character(dataset_options), : GDAL Error 1: data/pts_sf.shp does not
## appear to be a file or directory.</code></pre>
<pre><code>## Deleting source `data/pts_sf.shp&#39; failed
## Writing layer `pts_sf&#39; to data source `data/pts_sf.shp&#39; using driver `ESRI Shapefile&#39;
## features:       66
## fields:         5
## geometry type:  Point</code></pre>
<pre class="r"><code># Here st_write had to guess the driver from the datasource name extension, but we can also specify it:
# st_write(pts_sf, &quot;data/pts_sf.shp&quot;, driver = &quot;ESRI Shapefile&quot;)</code></pre>
</div>
</div>
<div id="import-shapefile-data" class="section level2">
<h2>Import Shapefile data</h2>
<p>The shapefile contains polygons delimiting the woods of the Montreal agglomeration and information about the forest composition (found <a href="http://donnees.ville.montreal.qc.ca/dataset/29791562-f050-401e-b405-5c1fbf427f65">here</a>).</p>
<pre class="r"><code># Download shapefile from web page in your working directory

download.file(&quot;http://donnees.ville.montreal.qc.ca/dataset/29791562-f050-401e-b405-5c1fbf427f65/resource/9fa20d3a-5dee-43d6-9bc9-5d86fe225e16/download/bois.zip&quot;, destfile = &quot;data/bois.zip&quot;)

unzip(&quot;data/bois.zip&quot;, exdir = &quot;data&quot;)

# Read shapefile in R

bois &lt;- st_read(dsn = &quot;data/&quot;, layer = &quot;bois&quot;)</code></pre>
<pre><code>## Reading layer `bois&#39; from data source `/home/kevcaz/Github/Websites/inSileco.github.io/content/post/rinspace-import-spatial/data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 2716 features and 4 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -73.97557 ymin: 45.40957 xmax: -73.48204 ymax: 45.69943
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs</code></pre>
<pre class="r"><code>head(bois)</code></pre>
<pre><code>## Simple feature collection with 6 features and 4 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -73.86056 ymin: 45.43293 xmax: -73.49655 ymax: 45.69584
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
##   OBJECTID GR_ESSENC Shape_Leng Shape_Area                       geometry
## 1        2  Feuillus   515.4464   7199.995 MULTIPOLYGON (((-73.49961 4...
## 2        3  Feuillus   364.7666   8354.159 MULTIPOLYGON (((-73.51461 4...
## 3        5  Feuillus   134.2015   1139.293 MULTIPOLYGON (((-73.56527 4...
## 4        6  Feuillus   336.2568   4222.548 MULTIPOLYGON (((-73.4967 45...
## 5        8  Feuillus   510.9489   5168.669 MULTIPOLYGON (((-73.85932 4...
## 6        9  Feuillus   605.2992  10936.294 MULTIPOLYGON (((-73.85413 4...</code></pre>
<p>The <code>bois</code> dataset is a <code>MULTIPOLYGON</code> object and has the same CRS (EPSG: 4326) than the sample points. If that had not been the case, it would have been necessary to transform one of the <code>sf</code> objects (see post about Projection) because to perform any spatial operations on two spatial objects requires that they have the same coordinate reference system.</p>
<p>To plot only the geometry and not all attributes, we can retrieve the geometry list-column using <code>st_geometry</code>:</p>
<pre class="r"><code>plot(st_geometry(bois))</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/plot_poly_geom-1.png" width="672" /></p>
<p>To plot the polygons with a thematic color scale according to one attribute of interest:</p>
<pre class="r"><code>plot(bois[&quot;Shape_Area&quot;])</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/plot_poly_area-1.png" width="672" /></p>
</div>
<div id="import-geojson-file" class="section level2">
<h2>Import GeoJSON file</h2>
<p>This GeoJSON dataset contains watercourses (stream, river) and main ditches of the Montreal agglomeration (found <a href="http://donnees.ville.montreal.qc.ca/dataset/c128aff5-325c-4599-ab66-1c9d0b3abc94">here</a>). Hence, it is a <code>MULTILINE</code> object.</p>
<pre class="r"><code># Download shapefile from web page in your working directory

download.file(&quot;http://donnees.ville.montreal.qc.ca/dataset/c128aff5-325c-4599-ab66-1c9d0b3abc94/resource/0f64976e-19c1-4d29-bcc5-4b663a392617/download/courseau.geojson&quot;, destfile=&quot;data/courseau.geojson&quot;)

# For GeoJSON, dsn may be the character string holding the geojson data

courseau &lt;- st_read(dsn = &quot;data/courseau.geojson&quot;)</code></pre>
<pre><code>## Reading layer `courseau&#39; from data source `/home/kevcaz/Github/Websites/inSileco.github.io/content/post/rinspace-import-spatial/data/courseau.geojson&#39; using driver `GeoJSON&#39;
## Simple feature collection with 1306 features and 5 fields
## geometry type:  MULTILINESTRING
## dimension:      XY
## bbox:           xmin: -73.97268 ymin: 45.41593 xmax: -73.4975 ymax: 45.69939
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs</code></pre>
<pre class="r"><code>head(courseau)</code></pre>
<pre><code>## Simple feature collection with 6 features and 5 fields
## geometry type:  MULTILINESTRING
## dimension:      XY
## bbox:           xmin: -73.9206 ymin: 45.42815 xmax: -73.9066 ymax: 45.47614
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
##   OBJECTID_1              NOM     TYPE Shape_Le_1 NuméroRui
## 1          1 rivière à l&#39;Orme  rivière  177.95299      &lt;NA&gt;
## 2          2 rivière à l&#39;Orme  rivière  128.51146      &lt;NA&gt;
## 3          3             &lt;NA&gt;    fossé  172.42988      &lt;NA&gt;
## 4          4 rivière à l&#39;Orme  rivière  216.66838      &lt;NA&gt;
## 5          8             &lt;NA&gt;    fossé  540.29539      &lt;NA&gt;
## 6          9             &lt;NA&gt; ruisseau   97.66412      &lt;NA&gt;
##                         geometry
## 1 MULTILINESTRING ((-73.9107 ...
## 2 MULTILINESTRING ((-73.90824...
## 3 MULTILINESTRING ((-73.90667...
## 4 MULTILINESTRING ((-73.91472...
## 5 MULTILINESTRING ((-73.91029...
## 6 MULTILINESTRING ((-73.9206 ...</code></pre>
<pre class="r"><code>plot(st_geometry(courseau))</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/read_geojson-1.png" width="672" /></p>
</div>
<div id="import-raster-data-from-tif-file" class="section level2">
<h2>Import raster data from tif file</h2>
<p>For the illustration of raster concepts, we will use a tif file of a canopy index from Montreal (found <a href="http://cmm.qc.ca/donnees-et-territoire/observatoire-grand-montreal/produits-cartographiques/donnees-georeferencees/">here</a>). The canopy index, computed by the Montreal Metropolitain Community (CMM) from an NDVI index and an elevation surface model, represents the low vegetation cover, the high vegetation cover of more than 3 meters (the canopy), the low mineral surfaces and the high mineral surfaces more than 3 meters (roof).</p>
<pre class="r"><code># Download tif file from web page in your working directory
download.file(&quot;http://cmm.qc.ca/fileadmin/user_upload/geomatique/IndiceCanopee/2015/660_Canopee2015_3m.zip&quot;, destfile=&quot;data/canopee.zip&quot;)

unzip(&quot;data/canopee.zip&quot;, exdir = &quot;data&quot;)

# Read tif in R using raster
# The file named &quot;660_CLASS_3m.tif&quot; contains the canopy index for all the Montreal area, so we can read this file only

canopee_mtl &lt;- raster(&quot;data/660_CLASS_3m.tif&quot;)</code></pre>
<p>The canopy index raster has values from 1 to 5, has <code>nrow(canopee_mtl)</code> pixels by row and <code>ncol(canopee_mtl)</code> pixels by column. Note that in contrast to the sf package, raster uses the <code>proj4string</code> representation of the coordinate reference system.</p>
<pre class="r"><code>canopee_mtl</code></pre>
<pre><code>## class       : RasterLayer 
## dimensions  : 35754, 40854, 1460693916  (nrow, ncol, ncell)
## resolution  : 1, 1  (x, y)
## extent      : 265961, 306815, 5027324, 5063078  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=tmerc +lat_0=0 +lon_0=-73.5 +k=0.9999 +x_0=304800 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
## data source : /home/kevcaz/Github/Websites/inSileco.github.io/content/post/rinspace-import-spatial/data/660_CLASS_3m.tif 
## names       : X660_CLASS_3m 
## values      : 1, 5  (min, max)</code></pre>
<p>Similar to the sf package, raster also provides <code>plot</code> methods for its own classes.</p>
<pre class="r"><code>plot(canopee_mtl)</code></pre>
<p><img src="/rmarkdown-libs/figure-html4/plot_tif-1.png" width="672" /></p>
<br><br>
<center>
[<i class="fa fa-arrow-circle-o-left fa-3x" aria-hidden="true"></i>]({{&lt; ref “rinspace_homepage” &gt;}})
   
[<i class="fa fa-home fa-3x" aria-hidden="true"></i>]({{&lt; ref “rinspace_homepage” &gt;}})
   
[<i class="fa fa-arrow-circle-o-right fa-3x" aria-hidden="true"></i>]({{&lt; ref “rinspace_resources” &gt;}})
</center>
</div>
