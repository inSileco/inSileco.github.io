---
title: R in Space - Custom maps
author: [david, marieh, nicolas, kevin, elliot, steve]
tags: [R in Space, R, Spatial]
rpkgs: [graphics, raster, sf, sp]
draft: false
tweet: "R in Space - Custom maps"
date: 2018-04-06
navposts:
  prev: rinspace_rdataresources
  home: rinspace_homepage
output:
  rmarkdown::html_base:
    fig_width: 3
    dev: svg
---


```{r codeChunkSetUp, echo=FALSE}
source('../../../static/Rscript/codeChunkSetUp.R')
```


## Creating a thematic map

In this post, we go through all the steps required to produce a complete good-looking map. We will see how to add a title, a legend, a scale, axis and a North arrow and choose a good color palette. To do so, we will use the Quebec province as our sampled area.

So, first, we import 2 vector layers readily available in R, the Canadian provincial boundaries and USA country boundary.

```{r getdata, message = F}
library(sf)
library(raster)

# Create a new directory
dir.create("data")

can1 <- getData("GADM", country = "CAN", level = 1, path = "data")
usa0 <- getData("GADM", country = "USA", level = 0, path = "data")
```

Transform to `sf` objects to facilitate manipulation

```{r st_sf, message = F}
can1_sf <- st_as_sf(can1)
usa0_sf <- st_as_sf(usa0)
```

Retrieve Quebec polygon and surrounding provinces

```{r getQc, message = F}
qc <- can1_sf[can1_sf$NAME_1 == "Québec",]

qc_neigh <- can1_sf[can1_sf$NAME_1 %in% c("Québec","Ontario", "Nova Scotia","New Brunswick", "Newfoundland and Labrador"),]
```



It would take a while to plot because there is a lot of unnecessary details, so we
can simplify the shape of the polygons using `st_simplify()`.


```{r simplify}
usa0_simple <- st_simplify(usa0_sf, dTolerance = .05, preserveTopology = F) 
qc_simple <- st_simplify(qc, dTolerance = .01, preserveTopology = F)
qc_neigh_simple <- st_simplify(qc_neigh, dTolerance = .01, preserveTopology = F)

```


The warning stating that st_simplify does not correctly simplify longitude/latitude data and it should be in decimal degrees. It's important in some spatial operations involving distances, but we can ignore it for the purpose of mapping. 

Let's look at what we have :

```{r map_1, message = F, fig.height=4, fig.width=4}
plot(st_geometry(qc_simple), col = "grey85")
plot(st_geometry(qc_neigh_simple),  col = "grey45", add = T)
plot(st_geometry(usa0_simple), col = "grey25", add = T)
```


Let's say we sampled vegetation in 100 plots in Quebec; we now want to plot them with points proportional to their species richness. We will now create a data frame containing coordinates and random values from 5 to 50.

```{r points, message = F}
# Sample random points from our study area
sample_pts <- st_sample(x = qc_simple, size = 100)

# Create an attribute of fake species richness
sample_richness <- sample(x = 5:50, size = 100, replace = TRUE)
```

## Add a temperature raster

If we were interested in the latitudinal temperature gradient, we could add a
raster of mean temperature as a background to our map. 
We will use a low resolution so it does not take to long.

```{r temp, message = F}
temp <- getData("worldclim", var = "tmean", res = 10)

# Change projection to match with the polygons
temp <- projectRaster(temp, crs = st_crs(qc_simple)$proj4string)

# There are 12 layers in this raster. 
# Keep only the layer for June temperature: tmean6 and divide by 10 (because Worldclim temperature data are in °C * 10)
temp6 <- temp$tmean6/10
```


## Crop and mask the temperature raster using quebec boundary. 

First, `crop()` will decrease the extent of the raster using the extent of another spatial object and `mask()` keeps the raster values only in the area of interest and set the rest to NA.
Because `crop()` from `raster` expects a `sp` object we will use transform the polygon first. 

```{r crop, message = F}
temp_crop <- crop(temp6, as(qc_simple, "Spatial"))
temp_mask <- mask(temp_crop, qc_simple)
```

## Creating a simple layout

```{r layout}
my.layout <- layout(matrix(1:2, 2), heights = c(1,.14))
layout.show(my.layout)
```

  – `mar` controls the margins of the plot area;

  – `xaxs` and `yaxs` controls axis style.

```{r, eval=T, fig.width = 5.5, fig.height = 6}
library(RColorBrewer)

layout(matrix(1:2, 2), heights = c(1,.16))
par(las = 1, xaxs='i', yaxs='i', mar = rep(c(2.5,3),2))

myblu <- '#6da6c2'
mygre <- 'grey50'
mypal <- colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(124)

plot(st_geometry(qc_neigh_simple), 
     graticule = st_crs(qc_simple), # add graticules
     col ='#b5cfbd', border = mygre,
     xlim = c(-82,-56), ylim = c(43, 64))
plot(st_geometry(usa0_simple), col = "#b5cfbd", border = mygre, add = T)

# Temperature raster
image(temp_mask, add = T, col = mypal)

# Quebec boundary on top
plot(st_geometry(qc_simple), add = T, col = NA, border ='grey15', lwd =1.4)

# Sample points
plot(st_geometry(sample_pts), add = T, pch = 21, 
     bg = "#63636388", col = "grey15", lwd = 1.4, 
     cex = sample_richness/25) # Size proportional to richness

# Axis
axis(1)
axis(2, las = 1)
axis(3)
axis(4, las =1)
box(lwd=1.2)

# Compass rose
sp::compassRose(-57, 60)

# Legend
par(mar = c(3.2, 5, .5, 5), mgp = c(2,.5,0))

val <- range(values(temp_mask), na.rm =T)
image(as.matrix(seq(val[1], val[2], length = 512)), col = mypal, axes = F)
axis(1, at = seq(0.001, .999, length = 6), labels = round(seq(val[1], val[2], length = 6),2))
mtext(side = 1, line = 1.8, text = 'Mean annual temperature (°C)')

```

## Examples of complex layouts

The `layout()` function can be used to produce simple to very complex layouts
for figures. The previous figure was a rather simple example and we will show
two other examples from a scientific article that David is currently wrapping up.
These examples are simply to help visualizing the fact that as long as you can
position elements on a two-dimensional cartesian plane, than you can create
whatever visual you may have in mind with R.  

### Example 1

```{r layout1}
# Layout
mat <- matrix(0, 28, 32)
mat[1:12, 1:16] <- 1 # traffic
mat[15:26, 1:16] <- 2 # demersal
mat[1:12, 17:32] <- 3 # traffic + demersal
mat[18:28, 17:29] <- 4 # kernel
mat[15:17, 17:29] <- 5 # dens traffic (x)
mat[18:28, 30:32] <- 6 # dens demersal (y)
mat[13:14, 6:11] <- 7 # scale traffic
mat[27:28, 6:11] <- 8 # scale demersal
mat[13:14, 22:27] <- 9 # scale combine
mat[1:2, 15:16] <- 10 # panel A
mat[15:16, 15:16] <- 11 # panel B
mat[1:2, 31:32] <- 12 # panel C
mat[15:16, 31:32] <- 13 # panel D
layout(mat)
layout.show(13)
```

![](./layout1.png)

### Example 2

```{r layout2}
mat  <- matrix(0, 17, 10)
# Arrows
mat[1:3, 1:2] <- 1
mat[1:3, 9:10] <- 2
mat[15:17, 1:2] <- 3
mat[15:17, 9:10] <- 4
mat[9, 1:2] <- 5
mat[9, 9:10] <- 6
# Boxes
mat[4:8, 1:5] <- 7
mat[10:14, 1:5] <- 8
mat[4:8, 6:10] <- 9
mat[10:14, 6:10] <- 10
# Plots
mat[1:3, 3:8] <- 11 # all drivers before management
mat[15:17, 3:8] <- 12 # all drivers after management
mat[6:7, 2:3] <- 13 # waste before management
mat[12:13, 2:3] <- 14 # waste after management
mat[6:7, 8:9] <- 15 # fisheries before management
mat[12:13, 8:9] <- 16 # fisheries after management
# Text
mat[5, 2:5] <- 17 # Title 1
mat[11, 2:5] <- 18 # Title 2
mat[5, 6:9] <- 19 # Title 3
mat[11, 6:9] <- 20 # Title 4
mat[6:7, 4:5] <- 21 # local management before management
mat[12:13, 4:5] <- 22 # local management after management
mat[6:7, 6:7] <- 23 # regional management before management
mat[12:13, 6:7] <- 24 # regional management after management
layout(mat, heights = c(1,1,1,.2,.2,1,1,.2,.4,.2,.2,1,1,.2,1,1,1), widths = c(.2,1,1,1,.5,.5,1,1,1,.2))
layout.show(24)
```

![](./layout2.png)
